<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON to Excel Converter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(to bottom right, #eff6ff, #e0e7ff);
      min-height: 100vh;
      padding: 2rem;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      padding: 2rem;
    }
    
    .header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .icon {
      width: 2rem;
      height: 2rem;
      color: #4f46e5;
    }
    
    h1 {
      font-size: 1.875rem;
      color: #1f2937;
      font-weight: bold;
    }
    
    .description {
      color: #4b5563;
      margin-bottom: 1.5rem;
    }
    
    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }
    
    textarea {
      width: 100%;
      height: 16rem;
      padding: 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      resize: vertical;
    }
    
    textarea:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .alert {
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: start;
      gap: 0.5rem;
    }
    
    .alert-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }
    
    .alert-success {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #166534;
    }
    
    .alert-icon {
      width: 1.25rem;
      height: 1.25rem;
      flex-shrink: 0;
      margin-top: 0.125rem;
    }
    
    .buttons {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.875rem;
    }
    
    .btn-primary {
      background: #4f46e5;
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #4338ca;
    }
    
    .btn-primary:disabled {
      background: #d1d5db;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }
    
    .btn-secondary:hover {
      background: #d1d5db;
    }
    
    .btn-icon {
      width: 1.25rem;
      height: 1.25rem;
    }
    
    .tips {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #eff6ff;
      border-radius: 0.5rem;
    }
    
    .tips h3 {
      font-size: 1rem;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }
    
    .tips ul {
      list-style: none;
      color: #4b5563;
      font-size: 0.875rem;
    }
    
    .tips li {
      margin-bottom: 0.25rem;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
      </svg>
      <h1>JSON to Excel Converter</h1>
    </div>
    
    <p class="description">
      Paste your JSON data below and click convert to download as an Excel file.
    </p>

    <div>
      <label for="jsonInput">JSON Input</label>
      <textarea 
        id="jsonInput" 
        placeholder='Enter JSON here, e.g., [{"name": "John", "age": 30}]'
      ></textarea>
    </div>

    <div id="errorAlert" class="alert alert-error hidden">
      <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
      </svg>
      <p id="errorText"></p>
    </div>

    <div id="successAlert" class="alert alert-success hidden">
      <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
      </svg>
      <p>Excel file downloaded successfully!</p>
    </div>

    <div class="buttons">
      <button id="convertBtn" class="btn-primary">
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
        </svg>
        Convert to Excel
      </button>
      
      <button id="sampleBtn" class="btn-secondary">Load Sample JSON</button>
      <button id="clearBtn" class="btn-secondary">Clear</button>
    </div>

    <div class="tips">
      <h3>Tips:</h3>
      <ul>
        <li>• JSON should be an array of objects for best results</li>
        <li>• Each object will become a row in the Excel file</li>
        <li>• Object keys will become column headers</li>
        <li>• Single objects will be converted to a single-row table</li>
        <li>• Malformed fields with extra quotes will be automatically ignored</li>
      </ul>
    </div>
  </div>

  <script>
    const jsonInput = document.getElementById('jsonInput');
    const convertBtn = document.getElementById('convertBtn');
    const sampleBtn = document.getElementById('sampleBtn');
    const clearBtn = document.getElementById('clearBtn');
    const errorAlert = document.getElementById('errorAlert');
    const successAlert = document.getElementById('successAlert');
    const errorText = document.getElementById('errorText');

    function sanitizeJSON(jsonString) {
      let cleaned = jsonString.trim();
      cleaned = cleaned.replace(/^\uFEFF/, '');
      
      // Remove ANY field that has malformed quotes
      cleaned = cleaned.replace(/"[^"]+":"[^"]*""+[,}]/g, (match) => {
        return match.endsWith(',') ? '' : '}';
      });
      
      cleaned = cleaned.replace(/,"[^"]+":"[^"]*""+/g, '');
      cleaned = cleaned.replace(/:"([^"]*)""+/g, ':"$1"');
      cleaned = cleaned.replace(/:,/g, ':"",');
      cleaned = cleaned.replace(/:}/g, ':""}');
      cleaned = cleaned.replace(/:\]/g, ':""');
      cleaned = cleaned.replace(/"{3,}/g, '"');
      cleaned = cleaned.replace(/\\"/g, '"');
      cleaned = cleaned.replace(/,(\s*[}\]])/g, '$1');
      cleaned = cleaned.replace(/,,+/g, ',');
      cleaned = cleaned.replace(/\{,/g, '{');
      cleaned = cleaned.replace(/\{,\s*"/g, '{"');
      
      return cleaned;
    }

    function cleanDataForExcel(data) {
      if (Array.isArray(data)) {
        return data.map(item => cleanDataForExcel(item));
      } else if (data !== null && typeof data === 'object') {
        const cleaned = {};
        for (const [key, value] of Object.entries(data)) {
          try {
            if (typeof value === 'string') {
              let cleanedValue = value.replace(/\\n/g, '\n')
                                      .replace(/\\t/g, '\t')
                                      .replace(/\\r/g, '\r')
                                      .replace(/\\\\/g, '\\');
              cleaned[key] = cleanedValue;
            } else {
              cleaned[key] = cleanDataForExcel(value);
            }
          } catch (e) {
            cleaned[key] = '';
          }
        }
        return cleaned;
      }
      return data;
    }

    function showError(message) {
      errorText.textContent = message;
      errorAlert.classList.remove('hidden');
      successAlert.classList.add('hidden');
    }

    function showSuccess() {
      successAlert.classList.remove('hidden');
      errorAlert.classList.add('hidden');
    }

    function hideAlerts() {
      errorAlert.classList.add('hidden');
      successAlert.classList.add('hidden');
    }

    convertBtn.addEventListener('click', () => {
      hideAlerts();

      try {
        const input = jsonInput.value.trim();
        if (!input) {
          showError('Please enter JSON data');
          return;
        }

        let sanitized = sanitizeJSON(input);
        let data;

        try {
          data = JSON.parse(sanitized);
        } catch (firstError) {
          try {
            data = JSON.parse(input);
          } catch (secondError) {
            try {
              let aggressive = sanitized.replace(/""+/g, '"');
              data = JSON.parse(aggressive);
            } catch (thirdError) {
              const errorMsg = thirdError.message;
              const match = errorMsg.match(/position (\d+)/);
              if (match) {
                const pos = parseInt(match[1]);
                const snippet = sanitized.substring(Math.max(0, pos - 50), Math.min(sanitized.length, pos + 50));
                throw new Error(`Parse error near: ...${snippet}...`);
              }
              throw new Error('Unable to parse JSON: ' + errorMsg);
            }
          }
        }

        data = cleanDataForExcel(data);
        
        let arrayData;
        
        if (Array.isArray(data)) {
          if (data.length > 0 && typeof data[0] === 'object') {
            const nestedArrays = Object.values(data[0]).filter(val => Array.isArray(val));
            if (nestedArrays.length > 0) {
              arrayData = nestedArrays[0];
            } else {
              arrayData = data;
            }
          } else {
            arrayData = data;
          }
        } else if (typeof data === 'object') {
          const values = Object.values(data);
          const firstArray = values.find(val => Array.isArray(val));
          
          if (firstArray) {
            arrayData = firstArray;
          } else {
            arrayData = [data];
          }
        } else {
          throw new Error('JSON must be an object or array');
        }

        arrayData = arrayData.filter(item => 
          item && typeof item === 'object' && Object.keys(item).length > 0
        );

        if (arrayData.length === 0) {
          throw new Error('No valid data to convert');
        }

        const worksheet = XLSX.utils.json_to_sheet(arrayData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
        XLSX.writeFile(workbook, 'converted_data.xlsx');
        
        showSuccess();
      } catch (err) {
        showError(err.message || 'Invalid JSON format. Please check your input.');
      }
    });

    sampleBtn.addEventListener('click', () => {
      const sample = [
        { name: 'John Doe', age: 30, city: 'New York', email: 'john@example.com' },
        { name: 'Jane Smith', age: 25, city: 'Los Angeles', email: 'jane@example.com' },
        { name: 'Bob Johnson', age: 35, city: 'Chicago', email: 'bob@example.com' }
      ];
      jsonInput.value = JSON.stringify(sample, null, 2);
      hideAlerts();
    });

    clearBtn.addEventListener('click', () => {
      jsonInput.value = '';
      hideAlerts();
    });

    // Enable/disable convert button based on input
    jsonInput.addEventListener('input', () => {
      convertBtn.disabled = !jsonInput.value.trim();
    });

    // Initial state
    convertBtn.disabled = true;
  </script>
</body>
</html>